class Users

  def export
    keys, values = export_map()

    filename = [
      Cfg.hostname,
      self.class.name.split('::').last,
      Date.today
    ].join(' ')

    halt([
      200,
      {
        'Content-Type' => 'text/csv',
        'Content-Disposition' => 'attachment; filename=%s.csv' % filename
      },
      CSV.generate do |csv|
        csv << keys
        filtered_dataset(params).select(values).find_each do |u|
          csv << values.map {|c| u[c]}
        end
      end
    ])
  end

  private

  def export_map
    map = {
      'ID' => :id,
      'First Name' => :first_name,
      'Last Name' => :last_name,
      'Address' => :address,
      'Apt/Suite' => :address2,
      'City' => :city,
      'State' => :state,
      'Zip' => :zipcode,
      'Country' => :country,
      'Email' => :email,
      'Phone' => :phone,
    }
    [map.keys, map.values]
  end
end
