class Models

  def password_create_or_reset_email user_id, email_uuid, subject, body

    email = Email[email_uuid]
    email || halt(400, 'Email not found')

    @user.update_column(:password_reset_token, Helpers.generate_random_token)

    subject, body = Email.render(
      subject,
      body,
      render_context: {user: @user.serialized},
      layout: email.layout && email.layout.content
    )

    MailSpool.create({
      user_id: @user.id,
      email_id: email.id,
      email: @user.email,
      subject: subject,
      body: body,
      cc: email.cc,
      bcc: email.bcc
    })

    @user.update_column(@user.password_created_at ? :password_reset_email_sent_at : :password_create_email_sent_at, Time.now.utc)
    true
  end

end
